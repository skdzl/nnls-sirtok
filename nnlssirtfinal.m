clc;
clear;
%this is the NNLS initialized SIRT algorithm to process the inelastic 
%sacttering data
%yy is the measured inelastic sacttering spectra
%A is the matrix composed by the standard spectra for each element
%elp is the iteration parameter or MSE
%Kmax is the maxiamal iteration step 
%minvalue is the minimal value to impose the non negative constrains
A=[3.00E-02	1	1	1	1	1
6.91E-02	1.001373843	0.993022923	0.993531933	0.989443994	0.995155181
1.08E-01	1.002037581	0.985266048	0.983549703	0.9718747	0.988915301
1.47E-01	1.001710674	0.976836082	0.97084077	0.948987395	0.981585207
1.86E-01	1.000112583	0.967839734	0.956192595	0.922477355	0.973469743
2.25E-01	0.996962769	0.95838371	0.94039264	0.894039859	0.964873755
2.65E-01	0.991980691	0.948574718	0.924228364	0.86536911	0.956102088
3.04E-01	0.98488581	0.938519466	0.90848723	0.837845761	0.947459589
3.43E-01	0.975397587	0.928324661	0.89391708	0.812102941	0.939251103
3.82E-01	0.963443258	0.918097011	0.880692926	0.788660266	0.931781475
4.21E-01	0.950057679	0.907943222	0.868558789	0.767565559	0.925355551
4.60E-01	0.936643306	0.897974224	0.857248168	0.747986513	0.920166551
4.99E-01	0.924602836	0.88831783	0.846509988	0.729003783	0.9159612
5.38E-01	0.9151193	0.879106074	0.836173362	0.710179882	0.912374595
5.77E-01	0.908020097	0.870470992	0.82609338	0.691786194	0.909041836
6.16E-01	0.902616004	0.862544617	0.816125632	0.674146504	0.90559802
6.56E-01	0.898216777	0.855391746	0.806209491	0.657450607	0.901703166
6.95E-01	0.894176555	0.84880822	0.796462396	0.641732065	0.897116974
7.34E-01	0.890167612	0.842522642	0.787024563	0.627014547	0.891624065
7.73E-01	0.886001053	0.836263616	0.778033065	0.613300278	0.885009057
8.12E-01	0.88148856	0.829759744	0.769559587	0.600571622	0.877056571
8.51E-01	0.876448079	0.822913471	0.761614027	0.588796739	0.867642263
8.90E-01	0.87074998	0.816322611	0.754203866	0.577755857	0.857005936
9.29E-01	0.864290752	0.81075882	0.747333143	0.567091113	0.845478429
9.68E-01	0.856967079	0.806993754	0.740982511	0.556476481	0.833390582
1.01E+00	0.848765431	0.805799068	0.735122883	0.545940246	0.821073234
1.05E+00	0.840554395	0.807570578	0.729725139	0.535716423	0.808854549
1.09E+00	0.833703233	0.811200734	0.724759562	0.526041202	0.797051994
1.12E+00	0.829586955	0.815206148	0.720194814	0.517148059	0.78598036
1.16E+00	0.829398913	0.81810343	0.71599928	0.509269237	0.775954437
1.20E+00	0.832220698	0.81840919	0.712140034	0.50257066	0.767289018
1.24E+00	0.835771475	0.815021239	0.708542123	0.496839676	0.760165776
1.28E+00	0.8377477	0.808362186	0.705080768	0.491729493	0.754233919
1.32E+00	0.836002259	0.799235841	0.701628298	0.486934988	0.749009538
1.36E+00	0.830560807	0.788446012	0.698083178	0.482333767	0.744008724
1.40E+00	0.823039697	0.776796509	0.694579787	0.477853336	0.738747569
1.44E+00	0.815091741	0.76496107	0.691377645	0.473480809	0.732864674
1.48E+00	0.80830463	0.753093143	0.688737418	0.469403261	0.726488685
1.52E+00	0.803172299	0.741216106	0.686830754	0.46584974	0.719870759
1.55E+00	0.799281117	0.729353337	0.685516697	0.463087814	0.713262053
1.59E+00	0.796189979	0.717528214	0.684585709	0.461484913	0.706913722
1.63E+00	0.793471017	0.705782167	0.68382783	0.461422447	0.701027322
1.67E+00	0.79096922	0.694228845	0.68301051	0.463001343	0.695605992
1.71E+00	0.788786002	0.682999947	0.681867499	0.465755274	0.690603273
1.75E+00	0.787032717	0.672227177	0.680129801	0.469155479	0.6859727
1.79E+00	0.785818643	0.662042233	0.677554559	0.473059796	0.681667813
1.83E+00	0.785199483	0.652543871	0.674219346	0.477941215	0.677647755
1.87E+00	0.785173929	0.643699049	0.670416607	0.48434115	0.673894089
1.91E+00	0.785737906	0.635441779	0.666442755	0.493294796	0.670393983
1.95E+00	0.786876002	0.627706073	0.662561536	0.506459259	0.667134604
1.98E+00	0.788198142	0.620425944	0.658887816	0.525411756	0.66410312
2.02E+00	0.788862728	0.613548317	0.655494066	0.548979981	0.661278848
2.06E+00	0.788001281	0.607071784	0.652452475	0.573242106	0.658609695
2.10E+00	0.784763994	0.601007852	0.649804713	0.594104585	0.65603572
2.14E+00	0.779115825	0.595368027	0.647534926	0.606655646	0.653496978
2.18E+00	0.772134636	0.590163816	0.645620884	0.605333855	0.650933527
2.22E+00	0.764978414	0.585387895	0.644058524	0.58551095	0.64828476
2.26E+00	0.758793861	0.580957617	0.64315685	0.553230472	0.645487423
2.30E+00	0.754050631	0.576771508	0.643488904	0.521242809	0.642477598
2.34E+00	0.750168954	0.57272809	0.645635995	0.501199637	0.639191367
2.38E+00	0.746478788	0.568725887	0.649878847	0.49478244	0.635564813
2.42E+00	0.742315606	0.564685552	0.654713211	0.498742902	0.631562187
2.45E+00	0.737495401	0.560616252	0.657978511	0.509912004	0.627260422
2.49E+00	0.732680762	0.556549284	0.657516059	0.525835598	0.622764618
2.53E+00	0.728620457	0.552515943	0.652047713	0.544335277	0.618179878
2.57E+00	0.726059818	0.548547526	0.642409876	0.563667445	0.613611302
2.61E+00	0.72527485	0.544656114	0.629749841	0.584161351	0.609157282
2.65E+00	0.725599692	0.540776928	0.61521922	0.606764054	0.604889366
2.69E+00	0.726255908	0.536825972	0.600079915	0.631288577	0.600872393
2.73E+00	0.726466899	0.532719253	0.58571055	0.65339415	0.597171201
2.77E+00	0.725897736	0.528372775	0.573495358	0.667791225	0.593850629
2.81E+00	0.725225623	0.52372693	0.564625095	0.670833621	0.590956695
2.85E+00	0.725268955	0.518819657	0.558777966	0.663513266	0.588460136
2.88E+00	0.726845267	0.513713283	0.554920502	0.647634438	0.586312868
2.92E+00	0.730335939	0.508470132	0.552015182	0.62498818	0.584466809
2.96E+00	0.734977873	0.503152531	0.549203844	0.597336485	0.582873874
3.00E+00	0.739822519	0.4978252	0.546182071	0.566423791	0.58148888
3.04E+00	0.743921448	0.492562447	0.542751969	0.532882142	0.580278236
3.08E+00	0.74650775	0.487440974	0.538721793	0.495427812	0.579211252
3.12E+00	0.747361454	0.482537483	0.534151412	0.452639901	0.578257236
3.16E+00	0.746365187	0.477928677	0.529435125	0.405357557	0.577385496
3.20E+00	0.743401593	0.473677556	0.524990358	0.357495571	0.576563823
3.24E+00	0.738499277	0.469792308	0.521223552	0.313111291	0.575753919
3.28E+00	0.732193152	0.466267421	0.518425944	0.274202229	0.574915971
3.31E+00	0.725127837	0.46309738	0.516820015	0.24054175	0.574010163
3.35E+00	0.717947951	0.460276672	0.516627323	0.211721393	0.572996679
3.39E+00	0.711296063	0.457791537	0.518003577	0.186071625	0.571838839
3.43E+00	0.70580654	0.455595227	0.520841095	0.160841409	0.570512495
3.47E+00	0.702111701	0.453632747	0.524966346	0.133556339	0.568996636
3.51E+00	0.700843864	0.451849101	0.530204193	0.105635783	0.56727025
3.55E+00	0.702421339	0.450189296	0.536259358	0.081145931	0.565312322
3.59E+00	0.706274759	0.448614797	0.542635299	0.063756277	0.563108446
3.63E+00	0.711550017	0.447152912	0.548816274	0.053046321	0.560670625
3.67E+00	0.717392982	0.445847409	0.554315692	0.046403106	0.55801747
3.71E+00	0.722921377	0.444742058	0.559068525	0.041349894	0.555167588
3.74E+00	0.727102892	0.443880626	0.563326916	0.036487099	0.552139588
3.78E+00	0.728855424	0.443289738	0.567350752	0.030866943	0.548948845
3.82E+00	0.727096836	0.442927438	0.571604921	0.023543195	0.545597799
3.86E+00	0.72099665	0.442734625	0.577619932	0.013569625	0.542085655
3.90E+00	0.711277432	0.442652198	0.587271458	0	0.538411618
3.94E+00	0.69925361	0.442621058	0.602422954	0	0.534574894
3.98E+00	0.686240776	0.442583665	0.622810876	0	0.530572275
4.02E+00	0.673410534	0.442488734	0.643651059	0	0.526390894
4.06E+00	0.660902286	0.442286543	0.659581085	0	0.522015472
4.10E+00	0.648405004	0.441927369	0.665454492	0	0.517430728
4.14E+00	0.635605787	0.441361489	0.660619231	0	0.512621384
4.17E+00	0.622324035	0.440539997	0.648669846	0	0.507585024
4.21E+00	0.609486022	0.439417251	0.63336722	0	0.502370696
4.25E+00	0.598569576	0.437948428	0.618204216	0	0.497040317
4.29E+00	0.591056557	0.436088703	0.604850712	0	0.491655798
4.33E+00	0.588185725	0.43379325	0.594217458	0	0.486279056
4.37E+00	0.588807559	0.431062945	0.587212397	0	0.480966811
4.41E+00	0.590416983	0.428081456	0.584547091	0	0.47575502
4.45E+00	0.590493359	0.425078151	0.586399013	0	0.470674447
4.49E+00	0.586759728	0.422282396	0.592855693	0	0.465755854
4.53E+00	0.579771887	0.41992356	0.603968832	0	0.461030005
4.57E+00	0.571913217	0.418158269	0.618645749	0	0.456518124
4.60E+00	0.565597558	0.416852191	0.634436859	0	0.45220327
4.64E+00	0.563044673	0.415798252	0.648813853	0	0.448058961
4.68E+00	0.563778623	0.414789379	0.659409223	0	0.444058717
4.72E+00	0.565349919	0.413618499	0.665306936	0	0.440176055
4.76E+00	0.565263848	0.41211199	0.666360917	0	0.43640136
4.80E+00	0.561170194	0.41023004	0.662432183	0	0.432792476
4.84E+00	0.553145876	0.407966289	0.653751327	0	0.429424112
4.88E+00	0.543281773	0.405314378	0.641846794	0	0.426370977
4.92E+00	0.533729722	0.402267945	0.628531776	0	0.423707781
4.96E+00	0.526573257	0.398840291	0.615601416	0	0.421486599
5.00E+00	0.522487539	0.395123351	0.603872944	0	0.419668975
5.03E+00	0.520824183	0.39122872	0.592705266	0	0.418193821
5.07E+00	0.520883484	0.387267992	0.581338324	0	0.417000048
5.11E+00	0.521962148	0.383352762	0.569103887	0	0.416026565
5.15E+00	0.523264203	0.379583389	0.556459409	0	0.415215531
5.19E+00	0.523895063	0.376015284	0.544617196	0	0.414522079
5.23E+00	0.522955362	0.372692621	0.534803485	0	0.41390459
5.27E+00	0.519573322	0.369659577	0.528017193	0	0.413321446
5.31E+00	0.513788725	0.366960325	0.524221115	0	0.412731026
5.35E+00	0.50673992	0.364623965	0.523083003	0	0.412101514
5.39E+00	0.499630659	0.362619289	0.524268117	0	0.411440313
5.43E+00	0.493646028	0.360900012	0.527172166	0	0.410764628
5.46E+00	0.489156543	0.35941985	0.530682727	0	0.410091664
5.50E+00	0.485420088	0.358132518	0.533631082	0	0.409438627
5.54E+00	0.481614443	0.356992682	0.534919684	0	0.408824067
5.58E+00	0.476925787	0.355958803	0.534677691	0	0.408271914
5.62E+00	0.471044192	0.354990293	0.534068839	0	0.407807444
5.66E+00	0.464440765	0.354046564	0.534289255	0	0.40745593
5.70E+00	0.4576538	0.353087026	0.53614696	0	0.407242648
5.74E+00	0.451220337	0.352082399	0.538145237	0	0.407177739
5.78E+00	0.445568136	0.351048636	0.537939935	0	0.407210811
5.82E+00	0.44093243	0.350012999	0.533190371	0	0.407276337
5.86E+00	0.437528852	0.349002747	0.523005932	0	0.407308792
5.89E+00	0.435571139	0.348045142	0.509978214	0	0.407242648
5.93E+00	0.435014029	0.347161512	0.49721078	0	0.407010094
5.97E+00	0.435292483	0.346349446	0.487729182	0	0.406534176
6.01E+00	0.435779335	0.345600604	0.482567335	0	0.405735652
6.05E+00	0.435848112	0.344906642	0.480651287	0	0.404535284
6.09E+00	0.435038345	0.344259218	0.480805804	0	0.402853831
6.13E+00	0.43326999	0.343652486	0.481874182	0	0.400653845
6.17E+00	0.430516068	0.343090578	0.482844566	0	0.398065057
6.21E+00	0.426749971	0.342580122	0.482773257	0	0.395258988
6.25E+00	0.422133138	0.342127747	0.480717178	0	0.39240716
6.29E+00	0.417320444	0.341740081	0.476177522	0	0.389681096
6.32E+00	0.413046721	0.341409457	0.47002706	0	0.3872192
6.36E+00	0.410046609	0.341071021	0.463402422	0	0.385027404
6.40E+00	0.408764909	0.340645621	0.457405593	0	0.383078523
6.44E+00	0.408773101	0.34005411	0.451719801	0	0.38134537
6.48E+00	0.409478841	0.339217335	0.444142575	0	0.37980076
6.52E+00	0.410289784	0.33807059	0.432341035	0	0.378411599
6.56E+00	0.410595747	0.336606934	0.414287816	0	0.377121167
6.60E+00	0.409724675	0.33483387	0.391158085	0	0.375866835
6.64E+00	0.406991108	0.3327589	0.366038601	0	0.374585977
6.68E+00	0.401709588	0.330389528	0.34204171	0	0.373215963
6.72E+00	0.393606828	0.327750271	0.321557478	0	0.371706955
6.75E+00	0.384058251	0.324933713	0.304086868	0	0.370060269
6.79E+00	0.374851452	0.322049454	0.288408563	0	0.368290009
6.83E+00	0.367774028	0.319207092	0.27330934	0	0.36641028
6.87E+00	0.364093506	0.316516228	0.258180642	0	0.364435187
6.91E+00	0.362677234	0.314064529	0.243426915	0	0.362377519
6.95E+00	0.361700607	0.311851935	0.229549245	0	0.360244801
6.99E+00	0.359338953	0.309856453	0.217000478	0	0.358043242
7.03E+00	0.354195772	0.308056089	0.205535932	0	0.355779049
7.07E+00	0.347157043	0.306428852	0.194386118	0	0.353458432
7.11E+00	0.339866266	0.304922523	0.182768733	0	0.351080075
7.15E+00	0.33396744	0.303363973	0.170172904	0	0.348612562
7.18E+00	0.330758008	0.301549851	0.157498688	0	0.346016955
7.22E+00	0.329396718	0.299276804	0.146103159	0	0.343254313
7.26E+00	0.328227273	0.296341477	0.137339869	0	0.340285697
7.30E+00	0.32559177	0.292602657	0.131918144	0	0.337086015
7.34E+00	0.320146396	0.288167693	0.129178096	0	0.333685561
7.38E+00	0.312798952	0.28320607	0.128284699	0	0.330128479
7.42E+00	0.305439782	0.277887277	0.12840947	0	0.326458913
7.46E+00	0.299963319	0.272380801	0.128860168	0	0.322721004
7.50E+00	0.297972998	0.266869873	0.129073275	0	0.318946193
7.54E+00	0.29863762	0.261592705	0.128490319	0	0.315115108
7.58E+00	0.299912823	0.25680125	0.126654882	0	0.311195676
7.62E+00	0.299745364	0.252747464	0.123804681	0	0.307155822
7.65E+00	0.296261689	0.249683303	0.120466488	0	0.302963473
7.69E+00	0.289353474	0.247713287	0.117167729	0	0.298597103
7.73E+00	0.279914327	0.246352195	0.114242133	0	0.294077387
7.77E+00	0.268849354	0.244967375	0.111496643	0	0.289435549
7.81E+00	0.257056153	0.24292617	0.108649494	0	0.284702813
7.85E+00	0.245345041	0.239595928	0.105430988	0	0.279910402
7.89E+00	0.234470023	0.23452654	0.101956858	0	0.275095255
7.93E+00	0.225184168	0.227998092	0.098799849	0	0.270317173
7.97E+00	0.218178178	0.220473215	0.096559218	0	0.265641671
8.01E+00	0.213276547	0.21241454	0.095737051	0	0.261134266
8.05E+00	0.209669611	0.204284699	0.095958302	0	0.256860472
8.08E+00	0.20653317	0.196478136	0.096382637	0	0.252869862
8.12E+00	0.203075613	0.189116543	0.096165483	0	0.249148234
8.16E+00	0.199052715	0.182253428	0.094907742	0	0.245665441
8.20E+00	0.194674451	0.175942294	0.09377473	0	0.242391338
8.24E+00	0.190164545	0.170236647	0.094274994	0	0.239295779
8.28E+00	0.185721142	0.165159076	0.097887926	0	0.236345301
8.32E+00	0.181014985	0.160608497	0.104513156	0	0.233493185
8.36E+00	0.175221175	0.156452911	0.111694485	0	0.230689391
8.40E+00	0.167495601	0.152560318	0.116783533	0	0.227883884
8.44E+00	0.157052157	0.148798718	0.117321919	0	0.225026625
8.48E+00	0.144600898	0.145046419	0.113180369	0	0.222070368
8.51E+00	0.132443926	0.141222953	0.105791444	0	0.218979025
8.55E+00	0.122960558	0.137258162	0.09661653	0	0.215719297
8.59E+00	0.11845613	0.133081887	0.086993509	0	0.212257885
8.63E+00	0.118791956	0.128623966	0.077697342	0	0.208561492
8.67E+00	0.120883917	0.123844239	0.069342693	0	0.204606568
8.71E+00	0.12147254	0.11882253	0.062542077	0	0.200408559
8.75E+00	0.117355336	0.113668659	0.057675048	0	0.195992662
8.79E+00	0.107816424	0.10849245	0.054681992	0	0.19138407
8.83E+00	0.095536421	0.103403722	0.053454643	0	0.186607982
8.87E+00	0.083440476	0.09849302	0.053882531	0	0.181691686
8.91E+00	0.074426539	0.093773771	0.055817193	0	0.176670861
8.94E+00	0.069760519	0.089240122	0.059078121	0	0.171583279
8.98E+00	0.068178668	0.084886224	0.063483804	0	0.166466711
9.02E+00	0.068199633	0.080706225	0.068685563	0	0.161358931
9.06E+00	0.068347457	0.076690893	0.073342005	0	0.156288424
9.10E+00	0.067616505	0.072817478	0.075746726	0	0.151246528
9.14E+00	0.065829764	0.06905985	0.074195943	0	0.146215295
9.18E+00	0.06289457	0.065391878	0.06795295	0	0.141176776
9.22E+00	0.058719154	0.061787432	0.058603379	0	0.136113022
9.26E+00	0.053333931	0.058223037	0.048074303	0	0.131005926
9.30E+00	0.047014523	0.054685838	0.038264069	0	0.125836739
9.34E+00	0.040065862	0.051165636	0.030337682	0	0.120586554
9.37E+00	0.032793902	0.047652232	0.024684001	0	0.115236461
9.41E+00	0.025750212	0.044135427	0.021654594	0	0.109767553
9.45E+00	0.020049222	0.040607713	0.021509671	0	0.104162127
9.49E+00	0.016883875	0.037072346	0.023795213	0	0.098407303
9.53E+00	0.017445196	0.033535275	0.027721152	0	0.092491405
9.57E+00	0.021949396	0.030002448	0.032495439	0	0.086402757
9.61E+00	0.028054751	0.026479813	0.037282604	0	0.080129685
9.65E+00	0.033005049	0.022980195	0.041113117	0	0.073655826
9.69E+00	0.034044779	0.01954393	0.042991659	0	0.06694607
9.73E+00	0.029478528	0.01621823	0.041942454	0	0.059960618
9.77E+00	0.02080508	0.013050308	0.037789883	0	0.052659674
9.80E+00	0.010122411	0.010087376	0.031421837	0	0.04500344
9.84E+00	0	0.007376646	0.02379976	0	0.036952118
9.88E+00	0	0.004965331	0.015885095	0	0.02846591
9.92E+00	0	0.002900643	0.008639284	0	0.01950502
9.96E+00	0	0.001229796	0.003023772	0	0.010029649
1.00E+01	0	0	0	0	0
];
%since we did not observe the difference for energy channels larger than 60
%We use the truncated position to reduce the inverison inaccuracy 
a=A(1:60,2:6);
ptrue=rand(5,1);% Randomly generate the relative yields
ptrue1=ptrue;
sm=sum(ptrue1);
ptrue1=ptrue1/sm;%Normalized the relative yields
y11=a*ptrue1; %obtained the recorverd spectra

 [m,k]=size(y11); %always k=1
   [m,n]=size(a);
   % n is the number of elements
   %m is the count numbers 
   %start the NNLS inversion using the code in Matlab
    p=lsqnonneg(a,y11)';
    % p is the initial values obtained by NNLS
    dt=1;
    elp=0.0000000001;
    %default elp 
    Kmax=10000;
    %default Kmax
    minvalue=0.00001;
    %default minvalue for the relative yields
    %% Start the SIRT inversion 
    k=0;      
    while dt>elp&k<Kmax
         jie=a*p';
         dit=y11-jie; 
         dt=sqrt(dit'*dit)/m;
        for i=1:1:m
            he(i)=0;
            for j=1:1:n
                he(i)=he(i)+a(i,j)^2;          
            end
        end
        for j=1:1:n
            sum(j)=0;
            LA(j)=0;
            for i=1:1:m
                dtap(j,i)=a(i,j)*dit(i)/he(i);
                sum(j)=sum(j)+dtap(j,i);
                if a(i,j)>=0
                   LA(j)= LA(j)+1;
                end
            end
        end
        dp=sum./LA;
        p=p+dp;
        % imposing the non negative constrains 
          for j=1:1:n
            if p(j)<0
               p(j)=minvalue;    %setting the nonnegative value
            end
        end 
        k=k+1;
    end
  pp=p' %% The inverted relative yields by NNLS-SIRT
  y1=A( : ,2:6)*p'; % obtained the recorverd spectra after the inversion without noisy

snrarray=[10 20 30 40 50 60 100 1000];%add the noisy 
for dk=1:8
    snr=snrarray(dk);
    yy=awgn(y11,snr);
    %since we did not observe the difference for energy channels larger than 60
    %We use the truncated position to reduce the inverison inaccuracy 
    [m,k]=size(yy);
    %always k=1
    [m,n]=size(a);
    % n is the number of elements
    %m is the count numbers 
    %%start the NNLS inversion using the code in Matlab
    p=lsqnonneg(a,yy)';
    % p is the initial values obtained by NNLS
    dt=1;
    elp=0.0000000001;
    %default elp 
    Kmax=10000;
    %default Kmax
    minvalue=0.00001;
    %default minvalue for the relative yields
    %% Start the SIRT inversion 
    k=0;      
    while dt>elp&k<Kmax
         jie=a*p';
         dit=yy-jie; 
         dt=sqrt(dit'*dit)/m;
        for i=1:1:m
            he(i)=0;
            for j=1:1:n
                he(i)=he(i)+a(i,j)^2;          
            end
        end
        for j=1:1:n
            sum(j)=0;
            LA(j)=0;
            for i=1:1:m
                dtap(j,i)=a(i,j)*dit(i)/he(i);
                sum(j)=sum(j)+dtap(j,i);
                if a(i,j)>=0
                   LA(j)= LA(j)+1;
                end
            end
        end
        dp=sum./LA;
        p=p+dp;
        % imposing the non negative constrains 
          for j=1:1:n
            if p(j)<0
               p(j)=minvalue;    %setting the nonnegative value
            end
        end 
        k=k+1;
    end
    pp=p' %% The inverted relative yields by NNLS-SIRT
       
    y4(:,dk)=A( : ,2:6)*p';%obtained the the recorverd spectra with snr=10 20 30 40 50 60 70 80 90 100
    
    y2=A( : ,2:6)*ptrue1;% obtained the forward spectra 
    y3(:,dk)=awgn(y2,snr);%obtained the forward spectra with snr=10 20 30 40 50 60 70 80 90 100

   end
   
    for i=1:8
    min_val = min(y3(:,i));
    max_val = max(y3(:,i));
    normalized_data = (y3(:,i) - min_val)/(max_val - min_val); %Normalized the forward spectra data
    datay3(:,i)=normalized_data;
    end
    y3=datay3;

   aa=A( : ,1);% obtained the energy line

    subplot(3,1,1);
    %draw the numerical simulated standard inelastic spectra:Mg,Ca,Si,O,C
    plot(aa,A( : ,6)+2,'r-',aa,A( : ,2)+1.5,'g-',aa,A( : ,3)+1,'b-',aa,A( : ,4)+0.5,'c-',aa,A( : ,5),'k-');
    title('The numerical simulated standard inelastic spectra');
    hleg = legend('Mg','Ca','Si','O','C','Location','NorthEastOutside');
    xlabel('Energy(Mev)');
    ylabel('Logarithmic counting');
    xlim([-0.3,10.3]);
    ylim([0,3.5]);
    set(gca,'yticklabel',[]); 
    
   
    subplot(3,1,2);
    plot(aa,y2,'r-',aa,y3(:,1),'g-'); %draw the forward noisy spectra with SNR=10 
    hold on;
    plot(aa,y2,'r-',aa,y3(:,2),'b-');%draw the forward noisy spectra with SNR=20
    hold on;
    plot(aa,y2,'r-',aa,y3(:,3),'c-');%draw the forward noisy spectra with SNR=30
    hold on;
    plot(aa,y2,'r-',aa,y3(:,4),'m-');%draw the forward noisy spectra with SNR=40
    hold on;
    plot(aa,y2,'r-',aa,y3(:,5),'y-');%draw the forward noisy spectra with SNR=50
    hold on;
    plot(aa,y2,'r-',aa,y3(:,6),'k-');%draw the forward noisy spectra with SNR=60
    hold on;
    plot(aa,y2,'r-',aa,y3(:,7),'w-');%draw the forward noisy spectra with SNR=100
    hold on;
    plot(aa,y2,'r-',aa,y3(:,8),'r--');%draw the forward noisy spectra with SNR=1000
    hold on;  
    xlabel('Energy(Mev)');
    ylabel('Normalized counts');
    xlim([0,10.5]);
    ylim([0,1.1]);
    title('The forward noisy spectra');
    hleg = legend('Mixed spectra','SNR=10','SNR=20','SNR=30','SNR=40','SNR=50','SNR=60','SNR=100','SNR=1000','Location','NorthEastOutside');
    
    subplot(3,1,3);
    plot(aa,y1,'r-',aa,y4(:, 1),'g-');%draw the recovered noisy spectra with SNR=10
    hold on;
    plot(aa,y1,'r-',aa,y4(:,2),'b-');%draw the recovered noisy spectra with SNR=20
    hold on;
    plot(aa,y1,'r-',aa,y4(:,3),'c-');%draw the recovered noisy spectra with SNR=30
    hold on;
    plot(aa,y1,'r-',aa,y4(:,4),'m-');%draw the recovered noisy spectra with SNR=40
    hold on;
    plot(aa,y1,'r-',aa,y4(:,5),'y-');%draw the recovered noisy spectra with SNR=50
    hold on;
    plot(aa,y1,'r-',aa,y4(:,6),'k-');%draw the recovered noisy spectra with SNR=60
    hold on;
    plot(aa,y1,'r-',aa,y4(:,7),'w-');%draw the recovered noisy spectra with SNR=100
    hold on;
    plot(aa,y1,'r-',aa,y4(:,8),'r--');%draw the recovered noisy spectra with SNR=1000
    hold on;
    xlabel('Energy(Mev)');
    ylabel('Normalized counts');
    xlim([0,10.5]);
    ylim([0,1.1]);
    title('The recovered noisy spectra');
    hleg = legend('Mixed spectra','SNR=10','SNR=20','SNR=30','SNR=40','SNR=50','SNR=60','SNR=100','SNR=1000','Location','NorthEastOutside');
    set (gcf,'windowstyle','normal')

 